import boto3
import json
import os
import datetime
from botocore.exceptions import ClientError

# --- CONFIG ---
AWS_REGION = 'us-west-2'
ec2 = boto3.client('ec2', region_name=AWS_REGION)
dynamodb = boto3.resource('dynamodb', region_name=AWS_REGION)
TABLE_NAME = 'elephant-meetings' # Ensure this matches your env variable or hardcode it

def terminate_ec2s(instance_ids):
    """
    Terminates a list of EC2 instance IDs.
    """
    # Filter out None, Empty strings, or 'UNKNOWN' placeholders
    targets = list(set([i for i in instance_ids if i and i != 'UNKNOWN']))
    
    if targets:
        print(f"TERMINATING INSTANCES: {targets}")
        try:
            ec2.terminate_instances(InstanceIds=targets)
            print("Termination signal sent successfully.")
        except ClientError as e:
            # If the instance is already terminated, this might throw an error.
            # We catch it so the Lambda doesn't crash.
            print(f"EC2 Termination Warning: {e}")

def lambda_handler(event, context):
    print(f"Stream Processor: Received {len(event['Records'])} records.")
    
    table = dynamodb.Table(TABLE_NAME)
    
    for record in event['Records']:
        # We only care about modifications (updates), not inserts or deletes
        if record['eventName'] != 'MODIFY':
            continue
            
        new_image = record['dynamodb']['NewImage']
        
        # 1. Check Data Completeness
        # DynamoDB Streams format uses type keys (e.g., {'S': 'some_url'})
        has_teacher = 'teacher_session_data' in new_image
        has_student = 'student_session_data' in new_image
        
        # If we don't have both sides yet, we do nothing.
        if not (has_teacher and has_student):
            continue

        # 2. Extract Meeting ID
        meeting_id = new_image['id']['S']

        # 3. Safety Gate: Duration Check
        # We prevent killing the room if the meeting is less than 15 minutes old.
        # This protects against "flapping" (users crashing/rejoining early).
        try:
            created_str = new_image['created_at']['S']
            # Handle ISO formats with or without Z
            created_at = datetime.datetime.fromisoformat(created_str.replace('Z', '+00:00'))
            now = datetime.datetime.now(datetime.timezone.utc)
            duration_minutes = (now - created_at).total_seconds() / 60
        except Exception as e:
            print(f"Error parsing time for {meeting_id}: {e}. Defaulting to SAFE (no kill).")
            continue

        if duration_minutes < 15:
            print(f"SAFETY GATE: Meeting {meeting_id} has both data, but duration is only {duration_minutes:.1f}m (< 15m). Keeping alive.")
            continue

        # 4. EXECUTE KILL
        print(f"SUCCESS: Meeting {meeting_id} complete (Duration: {duration_minutes:.1f}m). Terminating resources.")
        
        # Gather all possible Instance IDs from the record
        targets = []
        if 'teacher_instance_id' in new_image: targets.append(new_image['teacher_instance_id']['S'])
        if 'student_instance_id' in new_image: targets.append(new_image['student_instance_id']['S'])
        # Fallback for legacy schema
        if 'instance_id' in new_image: targets.append(new_image['instance_id']['S'])
        
        # Kill EC2s
        terminate_ec2s(targets)
        
        # Update DynamoDB Status to TERMINATED
        # We use a condition expression to avoid infinite loops if it's already terminated
        try:
            table.update_item(
                Key={'id': meeting_id},
                UpdateExpression="SET #s = :stat, termination_reason = :reason",
                ConditionExpression="#s <> :stat", 
                ExpressionAttributeNames={'#s': 'status'},
                ExpressionAttributeValues={
                    ':stat': 'TERMINATED', 
                    ':reason': 'STREAM_SUCCESS_COMPLETION'
                }
            )
            print(f"Status updated to TERMINATED for {meeting_id}")
        except ClientError as e:
            if e.response['Error']['Code'] == 'ConditionalCheckFailedException':
                print(f"Meeting {meeting_id} was already terminated.")
            else:
                print(f"Error updating DB: {e}")

    return {"status": "Processed"}